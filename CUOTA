<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script>
  netlifyIdentity.init();

  const roleQuotas = {
    'Ownership': Infinity,
    'Management': 50,
    'Administrator': 30,
    'Moderator': 20
  };

  function isMonday() {
    return new Date().getDay() === 1;
  }

  function displayQuota(user) {
    if (!user || !user.user_metadata) return;
    const quota = user.user_metadata.quota ?? 0;
    document.getElementById('quota').textContent = quota;
  }

  async function initUser(user) {
    if (!user) return;

    if (!user.user_metadata) user.user_metadata = {};
    const role = user.user_metadata.role || 'Moderator';
    const lastReset = user.user_metadata.lastReset;

    const todayStr = new Date().toDateString();

    // Reset quota on Monday if not already reset today
    if ((isMonday() && lastReset !== todayStr) || user.user_metadata.quota === undefined) {
      user.user_metadata.role = role;
      user.user_metadata.quota = roleQuotas[role];
      user.user_metadata.lastReset = todayStr;

      try {
        await user.update({ user_metadata: user.user_metadata });
        displayQuota(user);
      } catch (err) {
        console.error('Error updating user metadata:', err);
      }
    } else {
      displayQuota(user);
    }
  }

  function canPerformAction(user, actionType) {
    if (!user || !user.user_metadata) return false;

    const role = user.user_metadata.role;
    const quota = user.user_metadata.quota;

    if (quota <= 0 && role !== 'Ownership') return false;

    switch (role) {
      case 'Ownership': return true;
      case 'Management': return actionType !== 'manageOwnership';
      case 'Administrator': return actionType !== 'manageRoles';
      case 'Moderator': return actionType === 'moderateContent';
      default: return false;
    }
  }

  async function reduceQuota(user, amount = 1) {
    if (!user || user.user_metadata.role === 'Ownership') return;

    user.user_metadata.quota = Math.max(0, user.user_metadata.quota - amount);
    try {
      await user.update({ user_metadata: user.user_metadata });
      displayQuota(user);
    } catch (err) {
      console.error('Error reducing quota:', err);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const button = document.getElementById('actionButton');

    let user = netlifyIdentity.currentUser();

    if (!user) {
      // Open login modal
      netlifyIdentity.open();
      netlifyIdentity.on('login', async (loggedInUser) => {
        user = loggedInUser;
        await initUser(user);
      });
    } else {
      initUser(user);
    }

    if (button) {
      button.addEventListener('click', async () => {
        user = netlifyIdentity.currentUser();
        if (!canPerformAction(user, 'moderateContent')) {
          alert('Action not allowed or quota exceeded!');
          return;
        }
        await reduceQuota(user);
        alert('Action performed!');
      });
    }
  });
</script>

<p>Your remaining quota: <span id="quota">0</span></p>
<button id="actionButton">Perform Action</button>
